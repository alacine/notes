# Generated by Anaconda 34.24.9
# Generated by pykickstart v3.32
#version=DEVEL
# Use Text install
text

# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_US.UTF-8 --addsupport=zh_CN.UTF-8

# Network information
network  --hostname=fedora-master

# Use CDROM installation media
cdrom

#%packages --ignoremissing
%packages
@^server-product-environment
@guest-agents
@networkmanager-submodules
%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.3.3
ignoredisk --only-use=vda
#autopart
# Partition clearing information
clearpart --none --initlabel
# Disk partitioning information
part /boot --fstype="xfs" --ondisk=vda --size=1024
part pv.206 --fstype="lvmpv" --ondisk=vda --size=19455
volgroup fedora_fedora --pesize=4096 pv.206
logvol / --fstype="xfs" --size=19452 --name=root --vgname=fedora_fedora

# System timezone
timezone Asia/Shanghai --utc

# Root password
#rootpw --iscrypted $6$t7u1r0wMLUPUQOlL$/7K4s3uwkrbxQBs/W/TZNLIXRVP3tRvu4XuUaaGVGKQFB/6CmRDJbtDcdXTfVP4b3.SDb4p1UTWyLutaoskmX1
#user --groups=wheel --name=demo --password=$6$qv566FR0zwYTHeYi$j4llWv/MBD5CQNYcB8Qh38Z4fupN/fVtbPJfJ5pgs/X/BhMCFCV3LsRt0pgrSVZhRqxOiwtPmxZf3waD2V1HU1 --iscrypted --gecos="demo"
rootpw abcdef
user --groups=wheel --name=kube --password=abcdef --gecos="kube"

#repo --name="docker-ce-stable" --mirrorlist=https://download.docker.com/linux/fedora/docker-ce.repo
firewall --disable
selinux --disable

%post
dnf install -y iproute-tc
dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
dnf install -y docker-ce docker-ce-cli containerd.io
systemctl enable docker

modprobe br_netfilter
cat <<EOF | tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

# 这一步理由：kubernetes/build.md
dnf remove zram-generator-defaults
swapoff -a

cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

dnf install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
systemctl enable kubelet
%end

reboot --eject
